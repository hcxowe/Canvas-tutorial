<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" href="./css/zTreeStyle/zTreeStyle.css">

    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        .wrapper {
            position: relative;
            width: 1000px;
            height: 800px;
            margin: 0 auto;
            border: 1px solid #eee;
        }

        .tree-contaier {
            position: absolute;
            width: 300px;
            height: 300px;
            overflow: auto;
            border: 1px solid blue;
        }
    </style>

    <script src="./jquery-1.4.4.min.js"></script>
    <script src="./jquery.ztree.all.js"></script>
</head>
<body>
    <div class="wrapper">
        <div class="tree-contaier">
            <ul id="treeDemo1" class="ztree"></ul>
        </div>

        <div class="tree-contaier" style="left: 600px;">
            <ul id="treeDemo2" class="ztree"></ul>
        </div>

        <canvas id="canvas" width="1000" height="800"></canvas>
    </div>

    <script>
        $(document).ready(function(){
            var setting = {
                view: {
                    selectedMulti: false
                },
                callback: {
                    onClick: zTreeOnClick,
                    onCollapse: zTreeOnCollapse,
                    onExpand: zTreeOnExpand
                }
            };

            var zNodes =[
                { name:"父节点1 - 展开", open:true,
                    children: [
                        { name:"父节点11 - 折叠",
                            children: [
                                { name:"叶子节点111"},
                                { name:"叶子节点112"},
                                { name:"叶子节点113"},
                                { name:"叶子节点114"}
                            ]},
                        { name:"父节点12 - 折叠",
                            children: [
                                { name:"叶子节点121"},
                                { name:"叶子节点122"},
                                { name:"叶子节点123"},
                                { name:"叶子节点124"}
                            ]},
                        { name:"父节点13 - 没有子节点", isParent:true}
                    ]},
                { name:"父节点2 - 折叠",
                    children: [
                        { name:"父节点21 - 展开", open:true,
                            children: [
                                { name:"叶子节点211"},
                                { name:"叶子节点212"},
                                { name:"叶子节点213"},
                                { name:"叶子节点214"}
                            ]},
                        { name:"父节点22 - 折叠",
                            children: [
                                { name:"叶子节点221"},
                                { name:"叶子节点222"},
                                { name:"叶子节点223"},
                                { name:"叶子节点224"}
                            ]},
                        { name:"父节点23 - 折叠",
                            children: [
                                { name:"叶子节点231"},
                                { name:"叶子节点232"},
                                { name:"叶子节点233"},
                                { name:"叶子节点234"}
                            ]}
                    ]},
                { name:"父节点3 - 没有子节点", isParent:true}

            ];

            var relaAry = []


            $.fn.zTree.init($("#treeDemo1"), setting, zNodes);
            $.fn.zTree.init($("#treeDemo2"), setting, zNodes);

            var canvas = document.getElementById('canvas'),
                context = canvas.getContext('2d')

            var firstNode = null
            function zTreeOnClick(event, treeId, treeNode) {
                if (firstNode) {
                    draw(firstNode, treeNode)
                    firstNode = null
                }
                else {
                    firstNode = treeNode
                }
            };

            function zTreeOnCollapse() {
                drawLineByNode(relaAry)
            }

            function zTreeOnExpand() {
                drawLineByNode(relaAry)
            }

            function draw(fNode, sNode) {
                record(fNode, sNode)

                drawLineByNode(relaAry)
            }

            function record(fNode, sNode) {
                relaAry.push([fNode, sNode])
            }

            function drawLineByNode(ary) {
                context.clearRect(0, 0, 1000, 800)

                if (!ary.length) {
                    return
                }

                var wrapOffset = $('.wrapper').offset()

                context.strokeStyle = 'blue';
                context.beginPath()

                ary.forEach(function(el) {
                    var temp = []

                    el.forEach(function(item) {
                        if ($('#' + item.tId).is(':visible')) {
                            temp.push($('#' + item.tId))
                        }
                        else {
                            temp.push($('#' + item.tId).parents(':visible').eq(0))
                        }
                    })

                    var p1 = {
                        x: temp[0].offset().left - wrapOffset.left + temp[0].width(),
                        y: temp[0].offset().top - wrapOffset.top + temp[0].height() / 2,
                    }
                    var p2 = {
                        x: temp[1].offset().left - wrapOffset.left,
                        y: temp[1].offset().top - wrapOffset.top + temp[1].height() / 2,
                    }

                    context.moveTo(p1.x, p1.y);
                    context.lineTo(p2.x, p2.y);
                })

                context.stroke()
                context.closePath()
            }
        });
    </script>
</body>
</html>