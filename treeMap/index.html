<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <link rel="stylesheet" href="./css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="./index.css">

    <script src="./jquery-1.4.4.min.js"></script>
    <script src="./jquery.ztree.all.js"></script>
</head>
<body>
    <div id="container" class="wrapper">
        <canvas id="canvas"></canvas>
        <div id="colorBox" style="position:absolute; right: 10px;top:10px;">
            <span class="color-active" style="display:inline-block;width:16px;height:16px;background: #0000FF;"></span>
            <span style="display:inline-block;width:16px;height:16px;background: #FF00FF;"></span>
            <span style="display:inline-block;width:16px;height:16px;background: #A52A2A;"></span>
            <span style="display:inline-block;width:16px;height:16px;background: #7FFFD4;"></span>
            <span style="display:inline-block;width:16px;height:16px;background: #000000;"></span>
            <button id="clearBtn">删除</button>
            <button id="saveBtn">保存</button>
        </div>
    </div>

    <script src="./index.js"></script>
    <script>
        /* $(document).ready(function(){
            var setting = {
                view: {
                    selectedMulti: false,
                    nameIsHTML: true,
                    addDiyDom: addDiyDom
                },
                callback: {
                    onClick: zTreeOnClick,
                    onCollapse: zTreeOnCollapse,
                    onExpand: zTreeOnExpand
                }
            };

            function addDiyDom(treeId, treeNode) {
                var $li = $("#" + treeNode.tId)
                var $a = $("#" + treeNode.tId + "_a")
                $li.before('<span data-tid="' + treeNode.tId + '" class="dot-before"></span>')

                if (treeNode.isParent) {
                    $a.after('<span data-tid="' + treeNode.tId + '" class="dot-after"></span>')
                }
                else {
                    $a.after('<span data-tid="' + treeNode.tId + '" class="dot-after"></span>')
                }
            }

            var zNodes =[
                { name:"父节点1 - 展开", open:true,
                    children: [
                        { name:"父节点11", open:true,
                            children: [
                                { name:"叶子节点111"},
                                { name:"叶子节点112"},
                                { name:"叶子节点113"},
                                { name:"叶子节点114"}
                            ]},
                        { name:"父节点12",
                            children: [
                                { name:"叶子节点121"},
                                { name:"叶子节点122"},
                                { name:"叶子节点123"},
                                { name:"叶子节点124"}
                            ]},
                        { name:"父节点13 - 没有子节点", isParent:true}
                    ]},
                { name:"父节点2 - 折叠",
                    children: [
                        { name:"父节点21 - 展开", open:true,
                            children: [
                                { name:"叶子节点211"},
                                { name:"叶子节点212"},
                                { name:"叶子节点213"},
                                { name:"叶子节点214"}
                            ]},
                        { name:"父节点22 - 折叠",
                            children: [
                                { name:"叶子节点221"},
                                { name:"叶子节点222"},
                                { name:"叶子节点223"},
                                { name:"叶子节点224"}
                            ]},
                        { name:"父节点23 - 折叠",
                            children: [
                                { name:"叶子节点231"},
                                { name:"叶子节点232"},
                                { name:"叶子节点233"},
                                { name:"叶子节点234"}
                            ]}
                    ]},
                { name:"父节点3 - 没有子节点", isParent:true}

            ];

            var relaAry = []


            $.fn.zTree.init($("#treeDemo1"), setting, zNodes);
            $.fn.zTree.init($("#treeDemo2"), setting, zNodes);

            var canvas = document.getElementById('canvas'),
                context = canvas.getContext('2d')

            var wrapHeight = $('.wrapper')[0].scrollHeight
            $('#canvas').attr('height', wrapHeight-5)
            var wrapWidth = $('.wrapper')[0].scrollWidth
            $('#canvas').attr('width', wrapWidth)

            var firstID = null,
                relIDAry = [],
                lineing = false

            $('.wrapper').on('click', 'span[data-tid]', function(evt) {
                evt.stopPropagation()
                if (!firstID) {
                    firstID = $(this)
                    lineing = true

                    //context.save()
                    return
                }

                lineing = false
                //context.clearRect(0, 0, $('#canvas').attr('width'), $('#canvas').attr('height'))
                //context.restore()
                relIDAry.push([firstID, $(this)])
                firstID = null

                updateCanvas()
            })

            $(document).on('click', function() {
                if (!lineing)  return

                lineing = false
                firstID = null
                //context.clearRect(0, 0, $('#canvas').attr('width'), $('#canvas').attr('height'))
                updateCanvas()
            })

            function updateCanvas() {
                context.clearRect(0, 0, $('#canvas').attr('width'), $('#canvas').attr('height'))

                if (!relIDAry.length) {
                    return
                }

                var wrapOffset = $('.wrapper').offset()

                context.strokeStyle = 'blue';

                relIDAry.forEach(function(el) {

                    context.beginPath()
                    var temp = []

                    var active = false
                    el.forEach(function(item, index) {
                        if (activeNode && item.data('tid') == activeNode.tId) {
                            active = true
                        }

                        if (item.is(':visible')) {
                            temp.push(item)
                        }
                        else {
                            if (index == 0) {
                                var $parent = item.parents(':visible').eq(0)
                                temp.push($parent.find('span[data-tid="' + $parent.attr('id') + '"]'))
                            }
                            else {
                                temp.push(item.parents(':visible').eq(0).prev())
                            }
                        }
                    })

                    var color = 'blue'
                    if (active) {
                        color = 'red'
                    }
                    else {
                        color = 'blue'
                    }

                    var p1 = {
                        //x: temp[0].offset().left - wrapOffset.left + temp[0].width(),
                        //y: temp[0].offset().top - wrapOffset.top + temp[0].height() / 2,
                        x: temp[0].offset().left - wrapOffset.left + $('.wrapper').scrollLeft() + temp[0].width(),
                        y: temp[0].offset().top - wrapOffset.top + $('.wrapper').scrollTop() + temp[0].height() / 2,
                    }
                    var p2 = {
                        //x: temp[1].offset().left - wrapOffset.left,
                        //y: temp[1].offset().top - wrapOffset.top + temp[1].height() / 2,
                        x: temp[1].offset().left - wrapOffset.left + $('.wrapper').scrollLeft(),
                        y: temp[1].offset().top - wrapOffset.top + $('.wrapper').scrollTop() + temp[1].height() / 2,
                    }

                    //context.moveTo(p1.x, p1.y);
                    //context.lineTo(p2.x, p2.y);

                    drawArrow(context, p1.x, p1.y, p2.x, p2.y, 30, 10, 1, color)

                    //context.stroke()
                    //context.closePath()
                })
            }

            function drawArrow(ctx, fromX, fromY, toX, toY, theta, headlen, width, color) {
                theta = typeof (theta) != 'undefined' ? theta : 30;
                headlen = typeof (theta) != 'undefined' ? headlen : 10;
                width = typeof (width) != 'undefined' ? width : 1;
                color = typeof (color) != 'color' ? color : '#000';
                
                var angle = Math.atan2(toY - fromY, toX - fromX) * 180 / Math.PI,
                    angle1 = (angle + theta) * Math.PI / 180,
                    angle2 = (angle - theta) * Math.PI / 180,
                    topX = headlen * Math.cos(angle1),
                    topY = headlen * Math.sin(angle1),
                    botX = headlen * Math.cos(angle2),
                    botY = headlen * Math.sin(angle2);
                
                var ddX = 0; //4 * Math.cos(angle),
                    ddY = 0;//4 * Math.sin(angle)
                
                //ctx.save();
                
                ctx.lineJoin = 'miter'
                
                ctx.beginPath();
                var arrowX = 0,
                    arrowY = 0;
                
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(toX-ddX, toY-ddY);
                
                arrowX = toX - topX;
                arrowY = toY - topY;
                ctx.moveTo(arrowX, arrowY);
                ctx.lineTo(toX, toY);
                
                arrowX = toX - botX;
                arrowY = toY - botY;
                ctx.lineTo(arrowX, arrowY);
                
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.stroke();
                ctx.closePath()
                //ctx.restore();
            }

            var firstNode = null,
                activeNode = null
            function zTreeOnClick(event, treeId, treeNode) {
                activeNode = treeNode

                updateCanvas()
            };

            function zTreeOnCollapse() {
                //drawLineByNode(relaAry)
                updateCanvas()
            }

            function zTreeOnExpand() {
                //drawLineByNode(relaAry)
                updateCanvas()
            }

            function draw(fNode, sNode) {
                record(fNode, sNode)

                drawLineByNode(relaAry)
            }

            function record(fNode, sNode) {
                relaAry.push([fNode, sNode])
            }

            function drawLineByNode(ary) {
                context.clearRect(0, 0, $('#canvas').attr('width'), $('#canvas').attr('height'))

                if (!ary.length) {
                    return
                }

                var wrapOffset = $('.wrapper').offset()

                context.strokeStyle = 'blue';
                context.beginPath()

                ary.forEach(function(el) {
                    var temp = []

                    el.forEach(function(item) {
                        if ($('#' + item.tId).is(':visible')) {
                            temp.push($('#' + item.tId))
                        }
                        else {
                            temp.push($('#' + item.tId).parents(':visible').eq(0))
                        }
                    })

                    var p1 = {
                        x: temp[0].offset().left - wrapOffset.left + temp[0].width(),
                        y: temp[0].offset().top - wrapOffset.top + temp[0].height() / 2,
                    }
                    var p2 = {
                        x: temp[1].offset().left - wrapOffset.left,
                        y: temp[1].offset().top - wrapOffset.top + temp[1].height() / 2,
                    }

                    context.moveTo(p1.x, p1.y);
                    context.lineTo(p2.x, p2.y);
                })

                context.stroke()
                context.closePath()
            }

            var $wrapper = $('.wrapper'),
                $dragEl = null,
                distanceX = 0,
                distanceY = 0,
                isDrag = false

            $('.tree-title').on('mousedown', function(evt) {
                $dragEl = $(this).parent()
                var pOffset = $dragEl.offset()

                distanceX = evt.clientX - pOffset.left
                distanceY = evt.clientY - pOffset.top

                isDrag = true
            })

            $(document).off('mousemove').on('mousemove', function(evt){
                if (lineing) {
                    //context.clearRect(0, 0, $('#canvas').attr('width'), $('#canvas').attr('height'))

                    updateCanvas()

                    var wrapOffset = $('.wrapper').offset()
                    var p1 = {
                        x: firstID.offset().left - wrapOffset.left + $('.wrapper').scrollLeft() + firstID.width(),
                        y: firstID.offset().top - wrapOffset.top + $('.wrapper').scrollTop() + firstID.height() / 2,
                    }

                    var p2 = {
                        x: evt.clientX - wrapOffset.left + $('.wrapper').scrollLeft(),
                        y: evt.clientY - wrapOffset.top + $('.wrapper').scrollTop()
                    }

                    drawArrow(context, p1.x, p1.y, p2.x, p2.y, 30, 10, 1, 'green')
                    return
                }

                if (!isDrag) {
                    return
                }

                if ($wrapper[0].scrollHeight != wrapHeight) {
                    $('#canvas').attr('height', $wrapper[0].scrollHeight-5)
                    wrapHeight = $wrapper[0].scrollHeight
                }

                if ($wrapper[0].scrollWidth != wrapWidth) {
                    $('#canvas').attr('width', $wrapper[0].scrollWidth)
                    wrapWidth = $wrapper[0].scrollWidth
                }

                var ax = evt.clientX - distanceX,
                    ay = evt.clientY - distanceY

                $dragEl.offset({top: ay, left: ax})

                updateCanvas()
                //drawLineByNode(relaAry)
            })

            $(document).on('mouseup', function() {
                isDrag = false
            })
        }) */
    </script>
</body>
</html>